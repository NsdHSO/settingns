#!/bin/sh

# Emoji mapping
EMOJI_MAPPER() {
    local type=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    case $type in
        feat*) echo "ðŸŽ¸" ;;
        fix*) echo "ðŸ› ï¸" ;;
        docs*) echo "ðŸ“" ;;
        style*) echo "ðŸŽ¨" ;;
        refactor*|r) echo "ðŸ‘·" ;;
        test*) echo "ðŸ³" ;;
        chore*) echo "ðŸŒ»" ;;
        perf*) echo "ðŸš€" ;;
        revert*) echo "âª" ;;
        *) echo "" ;;
    esac
}

# Normalize commit type (lowercase to proper case)
NORMALIZE_TYPE() {
    local type="$1"
    local lowercase=$(echo "$type" | tr '[:upper:]' '[:lower:]')
    
    case $lowercase in
        feat*) echo "feat" ;;
        fix*) echo "fix" ;;
        docs*) echo "docs" ;;
        style*) echo "style" ;;
        refactor*|r) echo "refactor" ;;
        test*) echo "test" ;;
        chore*) echo "chore" ;;
        perf*) echo "perf" ;;
        revert*) echo "revert" ;;
        *) echo "$type" ;;
    esac
}

# Process commit message
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Extract commit type from first line
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

# Check if the commit message follows the pattern "type: message" or similar
if echo "$FIRST_LINE" | grep -q "^[A-Za-z]\+:\s*"; then
    # Extract type before the colon
    COMMIT_TYPE=$(echo "$FIRST_LINE" | cut -d ':' -f 1)
    
    # Extract remaining message after the colon (trim leading whitespace)
    MESSAGE_PART=$(echo "$FIRST_LINE" | cut -d ':' -f 2- | sed 's/^[[:space:]]*//')
    
    # Get matching emoji based on (lowercase) commit type
    EMOJI=$(EMOJI_MAPPER "$COMMIT_TYPE")
    
    # Normalize the commit type
    NORMALIZED_TYPE=$(NORMALIZE_TYPE "$COMMIT_TYPE")
    
    # Only process if an emoji was found
    if [ -n "$EMOJI" ]; then
        # Replace the first line while preserving ticket references
        # Make sure there's a space after the colon and before the emoji
        NEW_FIRST_LINE="$NORMALIZED_TYPE: $EMOJI$MESSAGE_PART"
        REMAINING_LINES=$(echo "$COMMIT_MSG" | tail -n +2)
        
        if [ -n "$REMAINING_LINES" ]; then
            # Multiple lines in commit message
            printf "%s\n%s\n" "$NEW_FIRST_LINE" "$REMAINING_LINES" > "$COMMIT_MSG_FILE"
        else
            # Single line commit message
            echo "$NEW_FIRST_LINE" > "$COMMIT_MSG_FILE"
        fi
    fi
fi